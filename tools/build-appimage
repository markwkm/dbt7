#!/bin/sh

usage()
{
	echo "usage: $(basename "${0}") [-d]"
	echo "  -d  use docker instead of podman"
}

CONTAINER_CMD=""
USE_DOCKER=0

while getopts "dh" opt; do
	case ${opt} in
	d)
		USE_DOCKER=1
		;;
	h)
		usage
		exit 0
		;;
	*)
		usage
		exit 1
		;;
	esac
done

if [ ${USE_DOCKER} -eq 1 ]; then
	if ! command -v docker > /dev/null 2>&1; then
		echo "docker is not in your path"
		exit 1
	fi
	CONTAINER_CMD="docker"
elif command -v podman > /dev/null 2>&1; then
	CONTAINER_CMD="podman"
elif command -v docker > /dev/null 2>&1; then
	CONTAINER_CMD="docker"
else
	echo "podman or docker is not in your path"
	exit 1
fi

CONTAINER_DIR=$(readlink -f "$(dirname "$0")")
CONTAINER_TAG="dbt7-appimage"
TARGET="appimage"

# Use the return code from `$CONTAINER_CMD inspect` to determine if the container
# image needs to be created.
if ! ${CONTAINER_CMD} inspect ${CONTAINER_TAG} > /dev/null 2>&1; then
	DOCKER_FLAG=""
	if [ "${CONTAINER_CMD}" = "docker" ]; then
		DOCKER_FLAG="-d"
	fi
	"${CONTAINER_DIR}/build-appimage-container" ${DOCKER_FLAG} || exit 1
fi

if [ "$ARCH" = "" ]; then
	ARCH="x86_64"
fi

# Apply patches for successful builds on the old CentOS 7 container image
eval ${CONTAINER_CMD} run \
		--rm \
		-v "${CONTAINER_DIR}/..:/usr/local/src/dbt7:rw,Z" \
		--env PKG_CONFIG_PATH="/usr/lib/pkgconfig" \
		--env ARCH="$ARCH" \
		--env DSGEN="${DSGEN}" \
		-w /usr/local/src/dbt7 \
		$CONTAINER_TAG \
		make DBMS="${DBMS}" -f Makefile.cmake "${TARGET}"

# With docker, files are created as root. Fix ownership to match the host user.
# Podman rootless already maps container root to the host user.
if [ "${CONTAINER_CMD}" = "docker" ]; then
	${CONTAINER_CMD} run \
			--rm \
			-v "${CONTAINER_DIR}/..:/usr/local/src/dbt7:rw,Z" \
			-w /usr/local/src/dbt7 \
			${CONTAINER_TAG} \
			chown -R "$(id -u):$(id -g)" builds
fi

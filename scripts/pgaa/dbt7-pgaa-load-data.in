#!/bin/sh
@SHELLOPTIONS@
#
# This file is released under the terms of the Artistic License.
# Please see the file LICENSE, included in this package, for details.
#
# Copyright The DBT-7 Authors

usage()
{
	cat << EOF
$(basename "${0}") is the Database Test 7 (DBT-7) EDB PGAA data loader

Usage:
  $(basename "${0}") [OPTION]

Options:
  --config FILE    FILE containing additional spark configuration settings
  --deltaspark     delta-spark version, default ${DELTASPARKVER}
  -o DIRECTORY     output DIRECTORY
  --sparkconnect   spark-connect version, default ${SPARKCONNECTVER}
  -?, --help       show this help, then exit
EOF
}

get_columns() {
	TABLE=${1}

	case "${TABLE}" in
		call_center)
			COLUMNS="cc_call_center_sk BIGINT,
cc_call_center_id CHAR(16),
cc_rec_start_date DATE,
cc_rec_end_date DATE,
cc_closed_date_sk INTEGER,
cc_open_date_sk INTEGER,
cc_name VARCHAR(50),
cc_class VARCHAR(50),
cc_employees INTEGER,
cc_sq_ft INTEGER,
cc_hours CHAR(20),
cc_manager VARCHAR(40),
cc_mkt_id INTEGER,
cc_mkt_class CHAR(50),
cc_mkt_desc VARCHAR(100),
cc_market_manager VARCHAR(40),
cc_division INTEGER,
cc_division_name VARCHAR(50),
cc_company INTEGER,
cc_company_name CHAR(50),
cc_street_number CHAR(10),
cc_street_name VARCHAR(60),
cc_street_type CHAR(15),
cc_suite_number CHAR(10),
cc_city VARCHAR(60),
cc_county VARCHAR(30),
cc_state CHAR(2),
cc_zip CHAR(10),
cc_country VARCHAR(20),
cc_gmt_offset DOUBLE,
cc_tax_percentage DOUBLE"
			;;
		catalog_page)
			COLUMNS="cp_catalog_page_sk BIGINT,
cp_catalog_page_id CHAR(16),
cp_start_date_sk INTEGER,
cp_end_date_sk INTEGER,
cp_department VARCHAR(50),
cp_catalog_number INTEGER,
cp_catalog_page_number INTEGER,
cp_description VARCHAR(100),
cp_type VARCHAR(100)"
			;;
		catalog_returns)
			COLUMNS="cr_returned_date_sk BIGINT,
cr_returned_time_sk BIGINT,
cr_item_sk BIGINT,
cr_refunded_customer_sk BIGINT,
cr_refunded_cdemo_sk BIGINT,
cr_refunded_hdemo_sk BIGINT,
cr_refunded_addr_sk BIGINT,
cr_returning_customer_sk BIGINT,
cr_returning_cdemo_sk BIGINT,
cr_returning_hdemo_sk BIGINT,
cr_returning_addr_sk BIGINT,
cr_call_center_sk BIGINT,
cr_catalog_page_sk BIGINT,
cr_ship_mode_sk BIGINT,
cr_warehouse_sk BIGINT,
cr_reason_sk BIGINT,
cr_order_number BIGINT,
cr_return_quantity INTEGER,
cr_return_amount DOUBLE,
cr_return_tax DOUBLE,
cr_return_amt_inc_tax DOUBLE,
cr_fee DOUBLE,
cr_return_ship_cost DOUBLE,
cr_refunded_cash DOUBLE,
cr_reversed_charge DOUBLE,
cr_store_credit DOUBLE,
cr_net_loss DOUBLE"
			;;
		catalog_sales)
			COLUMNS="cs_sold_date_sk BIGINT,
cs_sold_time_sk BIGINT,
cs_ship_date_sk BIGINT,
cs_bill_customer_sk BIGINT,
cs_bill_cdemo_sk BIGINT,
cs_bill_hdemo_sk BIGINT,
cs_bill_addr_sk BIGINT,
cs_ship_customer_sk BIGINT,
cs_ship_cdemo_sk BIGINT,
cs_ship_hdemo_sk BIGINT,
cs_ship_addr_sk BIGINT,
cs_call_center_sk BIGINT,
cs_catalog_page_sk BIGINT,
cs_ship_mode_sk BIGINT,
cs_warehouse_sk BIGINT,
cs_item_sk BIGINT,
cs_promo_sk BIGINT,
cs_order_number BIGINT,
cs_quantity INTEGER,
cs_wholesale_cost DOUBLE,
cs_list_price DOUBLE,
cs_sales_price DOUBLE,
cs_ext_discount_amt DOUBLE,
cs_ext_sales_price DOUBLE,
cs_ext_wholesale_cost DOUBLE,
cs_ext_list_price DOUBLE,
cs_ext_tax DOUBLE,
cs_coupon_amt DOUBLE,
cs_ext_ship_cost DOUBLE,
cs_net_paid DOUBLE,
cs_net_paid_inc_tax DOUBLE,
cs_net_paid_inc_ship DOUBLE,
cs_net_paid_inc_ship_tax DOUBLE,
cs_net_profit DOUBLE"
			;;
		customer)
			COLUMNS="c_customer_sk BIGINT,
c_customer_id CHAR(16),
c_current_cdemo_sk BIGINT,
c_current_hdemo_sk BIGINT,
c_current_addr_sk BIGINT,
c_first_shipto_date_sk BIGINT,
c_first_sales_date_sk BIGINT,
c_salutation CHAR(10),
c_first_name CHAR(20),
c_last_name CHAR(30),
c_preferred_cust_flag CHAR(1),
c_birth_day INTEGER,
c_birth_month INTEGER,
c_birth_year INTEGER,
c_birth_country VARCHAR(20),
c_login CHAR(13),
c_email_address CHAR(50),
c_last_review_date_sk BIGINT"
			;;
		customer_address)
			COLUMNS="ca_address_sk BIGINT,
ca_address_id CHAR(16),
ca_street_number CHAR(10),
ca_street_name VARCHAR(60),
ca_street_type CHAR(15),
ca_suite_number CHAR(10),
ca_city VARCHAR(60),
ca_county VARCHAR(30),
ca_state CHAR(2),
ca_zip CHAR(10),
ca_country VARCHAR(20),
ca_gmt_offset DOUBLE,
ca_location_type CHAR(20)"
			;;
		customer_demographics)
			COLUMNS="cd_demo_sk BIGINT,
cd_gender CHAR(1),
cd_marital_status CHAR(1),
cd_education_status CHAR(20),
cd_purchase_estimate INTEGER,
cd_credit_rating CHAR(10),
cd_dep_count INTEGER,
cd_dep_employed_count INTEGER,
cd_dep_college_count INTEGER"
			;;
		date_dim)
			COLUMNS="d_date_sk BIGINT,
d_date_id CHAR(16),
d_date DATE,
d_month_seq INTEGER,
d_week_seq INTEGER,
d_quarter_seq INTEGER,
d_year INTEGER,
d_dow INTEGER,
d_moy INTEGER,
d_dom INTEGER,
d_qoy INTEGER,
d_fy_year INTEGER,
d_fy_quarter_seq INTEGER,
d_fy_week_seq INTEGER,
d_day_name CHAR(9),
d_quarter_name CHAR(6),
d_holiday CHAR(1),
d_weekend CHAR(1),
d_following_holiday CHAR(1),
d_first_dom INTEGER,
d_last_dom INTEGER,
d_same_day_ly INTEGER,
d_same_day_lq INTEGER,
d_current_day CHAR(1),
d_current_week CHAR(1),
d_current_month CHAR(1),
d_current_quarter CHAR(1),
d_current_year CHAR(1)"
			;;
		household_demographics)
			COLUMNS="hd_demo_sk BIGINT,
hd_income_band_sk BIGINT,
hd_buy_potential CHAR(15),
hd_dep_count INTEGER,
hd_vehicle_count INTEGER"
			;;
		income_band)
			COLUMNS="ib_income_band_sk BIGINT,
ib_lower_bound INTEGER,
ib_upper_bound INTEGER"
			;;
		inventory)
			COLUMNS="inv_date_sk BIGINT,
inv_item_sk BIGINT,
inv_warehouse_sk BIGINT,
inv_quantity_on_hand INTEGER"
			;;
		item)
			COLUMNS="i_item_sk BIGINT,
i_item_id CHAR(16),
i_rec_start_date DATE,
i_rec_end_date DATE,
i_item_desc VARCHAR(200),
i_current_price DOUBLE,
i_wholesale_cost DOUBLE,
i_brand_id INTEGER,
i_brand CHAR(50),
i_class_id INTEGER,
i_class CHAR(50),
i_category_id INTEGER,
i_category CHAR(50),
i_manufact_id INTEGER,
i_manufact CHAR(50),
i_size CHAR(20),
i_formulation CHAR(20),
i_color CHAR(20),
i_units CHAR(10),
i_container CHAR(10),
i_manager_id INTEGER,
i_product_name CHAR(50)"
			;;
		promotion)
			COLUMNS="p_promo_sk BIGINT,
p_promo_id CHAR(16),
p_start_date_sk INTEGER,
p_end_date_sk INTEGER,
p_item_sk INTEGER,
p_cost DOUBLE,
p_response_target INTEGER,
p_promo_name CHAR(50),
p_channel_dmail CHAR(1),
p_channel_email CHAR(1),
p_channel_catalog CHAR(1),
p_channel_tv CHAR(1),
p_channel_radio CHAR(1),
p_channel_press CHAR(1),
p_channel_event CHAR(1),
p_channel_demo CHAR(1),
p_channel_details VARCHAR(100),
p_purpose CHAR(15),
p_discount_active CHAR(1)"
			;;
		reason)
			COLUMNS="r_reason_sk BIGINT,
r_reason_id CHAR(16),
r_reason_desc CHAR(100)"
			;;
		ship_mode)
			COLUMNS="sm_ship_mode_sk BIGINT,
sm_ship_mode_id CHAR(16),
sm_type CHAR(30),
sm_code CHAR(10),
sm_carrier CHAR(20),
sm_contract CHAR(20)"
			;;
		store)
			COLUMNS="s_store_sk BIGINT,
s_store_id CHAR(16),
s_rec_start_date DATE,
s_rec_end_date DATE,
s_closed_date_sk BIGINT,
s_store_name VARCHAR(50),
s_number_employees INTEGER,
s_floor_space INTEGER,
s_hours CHAR(20),
s_manager VARCHAR(40),
s_market_id INTEGER,
s_geography_class VARCHAR(100),
s_market_desc VARCHAR(100),
s_market_manager VARCHAR(40),
s_division_id INTEGER,
s_division_name VARCHAR(50),
s_company_id INTEGER,
s_company_name VARCHAR(50),
s_street_number VARCHAR(10),
s_street_name VARCHAR(60),
s_street_type CHAR(15),
s_suite_number CHAR(10),
s_city VARCHAR(60),
s_county VARCHAR(30),
s_state CHAR(2),
s_zip CHAR(10),
s_country VARCHAR(20),
s_gmt_offset DOUBLE,
s_tax_percentage DOUBLE"
			;;
		store_returns)
			COLUMNS="sr_returned_date_sk BIGINT,
sr_return_time_sk BIGINT,
sr_item_sk BIGINT,
sr_customer_sk BIGINT,
sr_cdemo_sk BIGINT,
sr_hdemo_sk BIGINT,
sr_addr_sk BIGINT,
sr_store_sk BIGINT,
sr_reason_sk BIGINT,
sr_ticket_number BIGINT,
sr_return_quantity INTEGER,
sr_return_amt DOUBLE,
sr_return_tax DOUBLE,
sr_return_amt_inc_tax DOUBLE,
sr_fee DOUBLE,
sr_return_ship_cost DOUBLE,
sr_refunded_cash DOUBLE,
sr_reversed_charge DOUBLE,
sr_store_credit DOUBLE,
sr_net_loss DOUBLE"
			;;
		store_sales)
			COLUMNS="ss_sold_date_sk BIGINT,
ss_sold_time_sk BIGINT,
ss_item_sk BIGINT,
ss_customer_sk BIGINT,
ss_cdemo_sk BIGINT,
ss_hdemo_sk BIGINT,
ss_addr_sk BIGINT,
ss_store_sk BIGINT,
ss_promo_sk BIGINT,
ss_ticket_number BIGINT,
ss_quantity INTEGER,
ss_wholesale_cost DOUBLE,
ss_list_price DOUBLE,
ss_sales_price DOUBLE,
ss_ext_discount_amt DOUBLE,
ss_ext_sales_price DOUBLE,
ss_ext_wholesale_cost DOUBLE,
ss_ext_list_price DOUBLE,
ss_ext_tax DOUBLE,
ss_coupon_amt DOUBLE,
ss_net_paid DOUBLE,
ss_net_paid_inc_tax DOUBLE,
ss_net_profit DOUBLE"
			;;
		time_dim)
			COLUMNS="t_time_sk BIGINT,
t_time_id CHAR(16),
t_time INTEGER,
t_hour INTEGER,
t_minute INTEGER,
t_second INTEGER,
t_am_pm CHAR(2),
t_shift CHAR(20),
t_sub_shift CHAR(20),
t_meal_time CHAR(20)"
			;;
		warehouse)
			COLUMNS="w_warehouse_sk BIGINT,
w_warehouse_id CHAR(16),
w_warehouse_name VARCHAR(20),
w_warehouse_sq_ft INTEGER,
w_street_number CHAR(10),
w_street_name VARCHAR(60),
w_street_type CHAR(15),
w_suite_number CHAR(10),
w_city VARCHAR(60),
w_county VARCHAR(30),
w_state CHAR(2),
w_zip CHAR(10),
w_country VARCHAR(20),
w_gmt_offset DOUBLE"
			;;
		web_page)
			COLUMNS="wp_web_page_sk BIGINT,
wp_web_page_id CHAR(16),
wp_rec_start_date DATE,
wp_rec_end_date DATE,
wp_creation_date_sk BIGINT,
wp_access_date_sk BIGINT,
wp_autogen_flag CHAR(1),
wp_customer_sk BIGINT,
wp_url VARCHAR(100),
wp_type CHAR(50),
wp_char_count INTEGER,
wp_link_count INTEGER,
wp_image_count INTEGER,
wp_max_ad_count INTEGER"
			;;
		web_returns)
			COLUMNS="wr_returned_date_sk BIGINT,
wr_returned_time_sk BIGINT,
wr_item_sk BIGINT,
wr_refunded_customer_sk BIGINT,
wr_refunded_cdemo_sk BIGINT,
wr_refunded_hdemo_sk BIGINT,
wr_refunded_addr_sk BIGINT,
wr_returning_customer_sk BIGINT,
wr_returning_cdemo_sk BIGINT,
wr_returning_hdemo_sk BIGINT,
wr_returning_addr_sk BIGINT,
wr_web_page_sk BIGINT,
wr_reason_sk BIGINT,
wr_order_number BIGINT,
wr_return_quantity INTEGER,
wr_return_amt DOUBLE,
wr_return_tax DOUBLE,
wr_return_amt_inc_tax DOUBLE,
wr_fee DOUBLE,
wr_return_ship_cost DOUBLE,
wr_refunded_cash DOUBLE,
wr_reversed_charge DOUBLE,
wr_account_credit DOUBLE,
wr_net_loss DOUBLE"
			;;
		web_sales)
			COLUMNS="ws_sold_date_sk BIGINT,
ws_sold_time_sk BIGINT,
ws_ship_date_sk BIGINT,
ws_item_sk BIGINT,
ws_bill_customer_sk BIGINT,
ws_bill_cdemo_sk BIGINT,
ws_bill_hdemo_sk BIGINT,
ws_bill_addr_sk BIGINT,
ws_ship_customer_sk BIGINT,
ws_ship_cdemo_sk BIGINT,
ws_ship_hdemo_sk BIGINT,
ws_ship_addr_sk BIGINT,
ws_web_page_sk BIGINT,
ws_web_site_sk BIGINT,
ws_ship_mode_sk BIGINT,
ws_warehouse_sk BIGINT,
ws_promo_sk BIGINT,
ws_order_number BIGINT,
ws_quantity INTEGER,
ws_wholesale_cost DOUBLE,
ws_list_price DOUBLE,
ws_sales_price DOUBLE,
ws_ext_discount_amt DOUBLE,
ws_ext_sales_price DOUBLE,
ws_ext_wholesale_cost DOUBLE,
ws_ext_list_price DOUBLE,
ws_ext_tax DOUBLE,
ws_coupon_amt DOUBLE,
ws_ext_ship_cost DOUBLE,
ws_net_paid DOUBLE,
ws_net_paid_inc_tax DOUBLE,
ws_net_paid_inc_ship DOUBLE,
ws_net_paid_inc_ship_tax DOUBLE,
ws_net_profit DOUBLE"
			;;
		web_site)
			COLUMNS="web_site_sk BIGINT,
web_site_id CHAR(16),
web_rec_start_date DATE,
web_rec_end_date DATE,
web_name VARCHAR(50),
web_open_date_sk BIGINT,
web_close_date_sk BIGINT,
web_class VARCHAR(50),
web_manager VARCHAR(40),
web_mkt_id INTEGER,
web_mkt_class VARCHAR(50),
web_mkt_desc VARCHAR(100),
web_market_manager VARCHAR(40),
web_company_id INTEGER,
web_company_name CHAR(50),
web_street_number CHAR(10),
web_street_name VARCHAR(60),
web_street_type CHAR(15),
web_suite_number CHAR(10),
web_city VARCHAR(60),
web_county VARCHAR(30),
web_state CHAR(2),
web_zip CHAR(10),
web_country VARCHAR(20),
web_gmt_offset DOUBLE,
web_tax_percentage DOUBLE"
			;;
		*)
			echo "Error: unrecognized table ${TABLE}"
			exit 1
			;;
	esac
	printf "%s" "${COLUMNS}"
}

if [ "${DELTASPARKVER}" = "" ]; then
	DELTASPARKVER="2.12:3.2.0"
fi
if [ "${SPARKCONNECTVER}" = "" ]; then
	SPARKCONNECTVER="2.12:3.5.6"
fi

OUTDIR="/tmp"

# Custom argument handling for hopefully most portability.
while [ "${#}" -gt 0 ] ; do
	case "${1}" in
	(--config)
		shift
		SPARKCONFIGFILE="${1}"
		;;
	(--config=?*)
		SPARKCONFIGFILE="${1#*--config=}"
		;;
	(--deltaspark)
		shift
		DELTASPARKVER="${1}"
		;;
	(--deltaspark=?*)
		DELTASPARKVER="${1#*--deltaspark=}"
		;;
	(-o)
		shift
		OUTDIR="${1}"
		mkdir -p ${OUTDIR}
		;;
	(--parallel)
		shift
		# NOOP
		;;
	(--parallel=?*)
		# NOOP
		;;
	(-s | --scale-factor)
		shift
		# NOOP
		;;
	(--scale-factor=?*)
		# NOOP
		;;
	(--sparkconnect)
		shift
		SPARKCONNECTVER="${1}"
		;;
	(--sparkconnect=?*)
		SPARKCONNECTVER="${1#*--sparkconnect=}"
		;;
	(-U)
		# NOOP
		;;
	(-\? | --help)
		usage
		exit 0
		;;
	(--* | -*)
		echo "$(basename "${0}"): invalid option -- '${1}'"
		echo "try \"$(basename "${0}") --help\" for more information."
		exit 1
		;;
	(*)
		break
		;;
	esac
	shift
done

if [ -z "${DS_DATA}" ]; then
	echo "Error: DS_DATA environment variable not defined"
	exit 1
fi

if [ -z "${DL_DATA}" ]; then
	echo "Error: DL_DATA environment variable not defined"
	exit 1
fi

if [ -z "${JAVA_HOME}" ]; then
	echo "Error: JAVA_HOME environment variable not defined"
	exit 1
fi

if [ -z "${SPARK_HOME}" ]; then
	echo "Error: SPARK_HOME environment variable not defined"
	exit 1
fi

echo "Saving output of delta lake generation to ${OUTDIR}..."

if [ ! "${SPARKCONFIGFILE}" = "" ]; then
	if [ ! -f "${SPARKCONFIGFILE}" ]; then
		echo "ERROR: spark config file not found: ${SPARKCONFIGFILE}"
		exit 1
	fi
	while IFS= read -r LINE || [ -n "${LINE}" ]; do
		SPARKCONFIG="${SPARKCONFIG} ${LINE}"
	done < "${SPARKCONFIGFILE}"
fi

if ! mkdir -p "${DL_DATA}"; then
	echo "ERROR: cannot create directory: ${DL_DATA}"
	exit 1
fi

for TABLE in call_center catalog_page catalog_returns catalog_sales customer \
		customer_address customer_demographics date_dim \
		household_demographics income_band inventory item promotion reason \
		ship_mode store store_returns store_sales time_dim warehouse web_page \
		web_returns web_sales web_site; do
	if ! eval "${SPARK_HOME}/bin/spark-sql \
				--packages org.apache.spark:spark-connect_${SPARKCONNECTVER},io.delta:delta-spark_${DELTASPARKVER} \
				--conf spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension \
				--conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog \
				--conf spark.sql.warehouse.dir=${DL_DATA} \
				--conf \"spark.hadoop.javax.jdo.option.ConnectionURL=jdbc:derby:${DL_DATA}/metastore_db;create=true\" \
				--conf spark.driver.extraJavaOptions=-Dderby.stream.error.file=${DL_DATA}/derby.log \
				${SPARKCONFIG} \
				--master local[*]" <<- EOF > "${OUTDIR}/${TABLE}.log" 2>&1
			CREATE TABLE ${TABLE}_csv ($(get_columns "${TABLE}"))
			USING csv
			OPTIONS (path '${DS_DATA}/${TABLE}.dat', header 'false', delimiter '|');

			CREATE TABLE ${TABLE}
			USING delta
			OPTIONS (path '${DL_DATA}/${TABLE}')
			AS SELECT * FROM ${TABLE}_csv;

			DROP TABLE ${TABLE}_csv;
		EOF
	then
		echo "ERROR: problem generating ${TABLE} delta lake: ${OUTDIR}/${TABLE}.log"
		exit 1
	fi
done

exit 0
